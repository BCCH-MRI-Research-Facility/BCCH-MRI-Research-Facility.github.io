<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.31">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Alex Weber">
<meta name="dcterms.date" content="2025-06-02">
<meta name="description" content="All things functional MRI">

<title>fMRI – BC Children’s Research MRI Wiki</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="..//img/magnet.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-4a990d8dcb58f517c7c86712b8f2ac7c.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-b663645d1a1882532027323d30525be4.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/quarto-contrib/fontawesome6-1.2.0/all.min.css" rel="stylesheet">
<link href="../site_libs/quarto-contrib/fontawesome6-1.2.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-B9X9W6319W"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-B9X9W6319W', { 'anonymize_ip': true});
</script>


<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="fMRI – BC Children’s Research MRI Wiki">
<meta property="og:description" content="All things functional MRI">
<meta property="og:image" content="https://BCCH-MRI-Research-Facility.github.io/mrimethods/img/icaclassification.png">
<meta property="og:site_name" content="BC Children's Research MRI Wiki">
<meta property="og:image:height" content="1046">
<meta property="og:image:width" content="926">
</head>

<body class="nav-sidebar docked nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../img/magnet.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">BC Children’s Research MRI Wiki</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../about.html" aria-current="page"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://bsky.app/profile/bcch-mri-research.bsky.social"> 
<span class="menu-text"><i class="fa-brands fa-bluesky" aria-label="bluesky"></i></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" role="link" aria-label=""><i class="bi bi-github"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/BCCH-MRI-Research-Facility/BCCH-MRI-Research-Facility.github.io">
            Source Code
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/BCCH-MRI-Research-Facility/BCCH-MRI-Research-Facility.github.io/issues">
            Report a Bug
            </a>
          </li>
      </ul>
    </div>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../mrimethods/index.html">MRI Methods</a></li><li class="breadcrumb-item"><a href="../mrimethods/fMRI.html">fMRI</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
  <div id="quarto-announcement" data-announcement-id="f8092d23da6c63237c7941459c020985" class="alert alert-primary hidden"><div class="quarto-announcement-content">
<p>🎉 Join our <a href="../orientation/instantmessaging.html">Mattermost</a> server to chat and collaborate; and follow us on <a href="https://bsky.app/profile/bcch-mri-research.bsky.social">Bluesky</a></p>
</div><i class="bi bi-x-lg quarto-announcement-action"></i></div>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../orientation/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Orientation</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../orientation/instantmessaging.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Mattermost: Instant Messaging / Stay in Touch</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../orientation/mrisafetyfaq.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MRI Safety FAQ</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../investigatorresources/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Investigator Resources</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../studentresources/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Student Resources</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../scienceresources/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Science Resources</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../tutorials/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Tutorials</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/docker.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Docker</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/git.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Git</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../tutorials/Python.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Python</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../mrisoftware/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MRI Software</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../mrisoftware/3D-Slicer.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">3D Slicer</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../mrimethods/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MRI Methods</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../mrimethods/acpc-align.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Align AC PC to horizontal</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../mrimethods/Anatomical.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Anatomical</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../mrimethods/ASL.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Arterial Spin Labelling</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../mrimethods/DTI.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">DTI</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../mrimethods/fMRI.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">fMRI</span></a>
  </div>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false">
 <span class="menu-text">EEG-fMRI</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../mrimethods/eeg-fmri/ballistocardiogram-removal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">EEG-fMRI Ballistocardiogram Cleaning (Rodriguez method)</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../mrimethods/eeg-fmri/gradient-removal.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">EEG-fMRI Data Cleaning &amp; Forward Solution</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../mriscanners/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MRI Scanners</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../about.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#starting-off" id="toc-starting-off" class="nav-link active" data-scroll-target="#starting-off">Starting off</a></li>
  <li><a href="#pulse-sequence-considerations" id="toc-pulse-sequence-considerations" class="nav-link" data-scroll-target="#pulse-sequence-considerations">Pulse-sequence considerations</a>
  <ul class="collapse">
  <li><a href="#do-you-want-a-low-tr" id="toc-do-you-want-a-low-tr" class="nav-link" data-scroll-target="#do-you-want-a-low-tr">Do you want a low TR?</a>
  <ul class="collapse">
  <li><a href="#so-why-would-someone-want-low-tr" id="toc-so-why-would-someone-want-low-tr" class="nav-link" data-scroll-target="#so-why-would-someone-want-low-tr"><strong>So why would someone want low TR?:</strong></a></li>
  <li><a href="#why-would-someone-want-to-avoid-low-trs" id="toc-why-would-someone-want-to-avoid-low-trs" class="nav-link" data-scroll-target="#why-would-someone-want-to-avoid-low-trs"><strong>Why would someone want to avoid low TRs?</strong>:</a></li>
  <li><a href="#general-concensus" id="toc-general-concensus" class="nav-link" data-scroll-target="#general-concensus"><strong>General concensus:</strong></a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references"><strong>References:</strong></a></li>
  </ul></li>
  <li><a href="#what-kind-of-acceleration-should-i-use" id="toc-what-kind-of-acceleration-should-i-use" class="nav-link" data-scroll-target="#what-kind-of-acceleration-should-i-use">What kind of acceleration should I use?</a></li>
  </ul></li>
  <li><a href="#preprocessing" id="toc-preprocessing" class="nav-link" data-scroll-target="#preprocessing">Preprocessing</a>
  <ul class="collapse">
  <li><a href="#dummy-scans" id="toc-dummy-scans" class="nav-link" data-scroll-target="#dummy-scans">Dummy scans:</a></li>
  <li><a href="#intensity-normalization" id="toc-intensity-normalization" class="nav-link" data-scroll-target="#intensity-normalization">Intensity Normalization</a></li>
  <li><a href="#nuisance-variable-removal" id="toc-nuisance-variable-removal" class="nav-link" data-scroll-target="#nuisance-variable-removal">Nuisance Variable Removal</a>
  <ul class="collapse">
  <li><a href="#nuisance-regression-of-wm-and-csf" id="toc-nuisance-regression-of-wm-and-csf" class="nav-link" data-scroll-target="#nuisance-regression-of-wm-and-csf">Nuisance regression of WM and CSF):</a></li>
  <li><a href="#using-outputs-from-fmriprep" id="toc-using-outputs-from-fmriprep" class="nav-link" data-scroll-target="#using-outputs-from-fmriprep">Using outputs from fmriprep:</a></li>
  </ul></li>
  <li><a href="#temporal-filtering" id="toc-temporal-filtering" class="nav-link" data-scroll-target="#temporal-filtering">Temporal Filtering</a></li>
  <li><a href="#spatial-smoothing" id="toc-spatial-smoothing" class="nav-link" data-scroll-target="#spatial-smoothing">Spatial Smoothing</a></li>
  </ul></li>
  <li><a href="#melodic-multivariate-exploratory-linear-optimized-decomposition-into-independent-components" id="toc-melodic-multivariate-exploratory-linear-optimized-decomposition-into-independent-components" class="nav-link" data-scroll-target="#melodic-multivariate-exploratory-linear-optimized-decomposition-into-independent-components">MELODIC (Multivariate Exploratory Linear Optimized Decomposition into Independent Components)</a>
  <ul class="collapse">
  <li><a href="#melodic-through-command-line" id="toc-melodic-through-command-line" class="nav-link" data-scroll-target="#melodic-through-command-line">Melodic through command line</a>
  <ul class="collapse">
  <li><a href="#easy-fsl_regfilt" id="toc-easy-fsl_regfilt" class="nav-link" data-scroll-target="#easy-fsl_regfilt">easy fsl_regfilt</a></li>
  </ul></li>
  <li><a href="#signal-classification" id="toc-signal-classification" class="nav-link" data-scroll-target="#signal-classification">Signal Classification</a></li>
  </ul></li>
  <li><a href="#ica-fix" id="toc-ica-fix" class="nav-link" data-scroll-target="#ica-fix">ICA FIX</a>
  <ul class="collapse">
  <li><a href="#fMRI-Install" id="toc-fMRI-Install" class="nav-link" data-scroll-target="#fMRI-Install">Install</a></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup">Setup:</a></li>
  <li><a href="#path" id="toc-path" class="nav-link" data-scroll-target="#path">Path</a></li>
  <li><a href="#files-needed" id="toc-files-needed" class="nav-link" data-scroll-target="#files-needed">Files needed</a></li>
  </ul></li>
  <li><a href="#global-rsns" id="toc-global-rsns" class="nav-link" data-scroll-target="#global-rsns">Global RSNs</a>
  <ul class="collapse">
  <li><a href="#identifying-rsns" id="toc-identifying-rsns" class="nav-link" data-scroll-target="#identifying-rsns">Identifying RSNs</a></li>
  </ul></li>
  <li><a href="#functional-connectivity-analysis" id="toc-functional-connectivity-analysis" class="nav-link" data-scroll-target="#functional-connectivity-analysis">Functional Connectivity Analysis</a>
  <ul class="collapse">
  <li><a href="#statistics" id="toc-statistics" class="nav-link" data-scroll-target="#statistics">Statistics</a>
  <ul class="collapse">
  <li><a href="#example" id="toc-example" class="nav-link" data-scroll-target="#example">Example:</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#fMRI-NetworkModellingAnalysis" id="toc-fMRI-NetworkModellingAnalysis" class="nav-link" data-scroll-target="#fMRI-NetworkModellingAnalysis">Network Modelling Analysis</a>
  <ul class="collapse">
  <li><a href="#nodes" id="toc-nodes" class="nav-link" data-scroll-target="#nodes">Nodes:</a>
  <ul class="collapse">
  <li><a href="#contiguous-vs-non-contiguous" id="toc-contiguous-vs-non-contiguous" class="nav-link" data-scroll-target="#contiguous-vs-non-contiguous">Contiguous vs Non-contiguous:</a></li>
  <li><a href="#binary-or-weighted" id="toc-binary-or-weighted" class="nav-link" data-scroll-target="#binary-or-weighted">Binary or Weighted:</a></li>
  <li><a href="#node-definition" id="toc-node-definition" class="nav-link" data-scroll-target="#node-definition">Node Definition:</a></li>
  </ul></li>
  <li><a href="#timeseries" id="toc-timeseries" class="nav-link" data-scroll-target="#timeseries">Timeseries:</a></li>
  <li><a href="#edges" id="toc-edges" class="nav-link" data-scroll-target="#edges">Edges:</a></li>
  <li><a href="#network-matrix" id="toc-network-matrix" class="nav-link" data-scroll-target="#network-matrix">Network Matrix:</a>
  <ul class="collapse">
  <li><a href="#hierarchical-clustering" id="toc-hierarchical-clustering" class="nav-link" data-scroll-target="#hierarchical-clustering">Hierarchical clustering:</a></li>
  </ul></li>
  <li><a href="#group-analysis" id="toc-group-analysis" class="nav-link" data-scroll-target="#group-analysis">Group Analysis</a></li>
  </ul></li>
  <li><a href="#notes-on-distortion-correction" id="toc-notes-on-distortion-correction" class="nav-link" data-scroll-target="#notes-on-distortion-correction">Notes on Distortion Correction</a></li>
  <li><a href="#multi-echo-fmri" id="toc-multi-echo-fmri" class="nav-link" data-scroll-target="#multi-echo-fmri">Multi-echo fMRI</a></li>
  <li><a href="#post-processing-pipelines" id="toc-post-processing-pipelines" class="nav-link" data-scroll-target="#post-processing-pipelines">Post-processing Pipeline(s):</a>
  <ul class="collapse">
  <li><a href="#xcp-d" id="toc-xcp-d" class="nav-link" data-scroll-target="#xcp-d">XCP-D</a></li>
  <li><a href="#conn-toolbox" id="toc-conn-toolbox" class="nav-link" data-scroll-target="#conn-toolbox">CONN Toolbox</a>
  <ul class="collapse">
  <li><a href="#tutorial" id="toc-tutorial" class="nav-link" data-scroll-target="#tutorial">Tutorial:</a></li>
  </ul></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/BCCH-MRI-Research-Facility/BCCH-MRI-Research-Facility.github.io/edit/main/mrimethods/fMRI.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/BCCH-MRI-Research-Facility/BCCH-MRI-Research-Facility.github.io/blob/main/mrimethods/fMRI.qmd" class="toc-action"><i class="bi empty"></i>View source</a></li><li><a href="https://github.com/BCCH-MRI-Research-Facility/BCCH-MRI-Research-Facility.github.io/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../mrimethods/index.html">MRI Methods</a></li><li class="breadcrumb-item"><a href="../mrimethods/fMRI.html">fMRI</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">fMRI</h1>
  <div class="quarto-categories">
    <div class="quarto-category">functional</div>
    <div class="quarto-category">t2*</div>
    <div class="quarto-category">visualization</div>
    <div class="quarto-category">resting state</div>
    <div class="quarto-category">task</div>
  </div>
  </div>

<div>
  <div class="description">
    All things functional MRI
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Alex Weber </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">June 2, 2025</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">June 2, 2025</p>
    </div>
  </div>
    
  </div>
  


</header>


<section id="starting-off" class="level1">
<h1>Starting off</h1>
<p>If you prefer to have a working understanding of the issues that fMRI data acquisition and analysis present before playing around with the software, I recommend starting with the introductory material from FSL and then a read of <a href="https://projecteuclid.org/download/pdfview_1/euclid.ss/1242049389">'The Statistical Analysis of fMRI Data' Martin A.Lindquist</a></p>
<p>This seems like a good resource as well:<br>
<a href="https://towardsdatascience.com/exploring-cognitive-differences-via-resting-state-networks-2112bf5291e2">https://towardsdatascience.com/exploring-cognitive-differences-via-resting-state-networks-2112bf5291e2</a></p>
<p>This paper has a very thorough example of typical fMRI preprocessing steps:<br>
<a href="https://www.frontiersin.org/articles/10.3389/fnins.2017.00685/full">https://www.frontiersin.org/articles/10.3389/fnins.2017.00685/full</a></p>
<p>Free course:<br>
<a href="https://ucl.podia.com/designing-and-analysing-fmri-experiments">https://ucl.podia.com/designing-and-analysing-fmri-experiments</a></p>
</section>
<section id="pulse-sequence-considerations" class="level1">
<h1>Pulse-sequence considerations</h1>
<p>If you are planning a study, here is some information to consider:</p>
<section id="do-you-want-a-low-tr" class="level2">
<h2 class="anchored" data-anchor-id="do-you-want-a-low-tr">Do you want a low TR?</h2>
<section id="so-why-would-someone-want-low-tr" class="level3">
<h3 class="anchored" data-anchor-id="so-why-would-someone-want-low-tr"><strong>So why would someone want low TR?:</strong></h3>
<ol type="1">
<li><strong><em>Improve temporal precision:</em></strong></li>
</ol>
<p>A shorter TR (e.g., &lt; 2 seconds) allows for more frequent sampling of the BOLD signal. Even though the HRF is slow, a faster TR can provide better temporal precision and align the timing of neural events more accurately to the fMRI signal. A shorter TR helps capture fast transitions in brain states, which can be important in cognitive tasks or resting-state analysis. A review of an updated view of the HRF can be found here: <strong>10.1016/j.pneurobio.2021.102174</strong></p>
<p>In resting-state fMRI (rs-fMRI), TR &lt; 2 seconds can be important because spontaneous brain activity happens continuously and can exhibit rapid changes over time. A faster TR provides better sampling to capture the fluctuations within resting-state networks and increases the ability to detect temporal correlations between regions of the brain.</p>
<p>In task-based fMRI, shorter TR acquisitions (on the order of 1000 ms) provide better discrimination between the activated and nonactivated brain tissue regions than do long-TR acquisitions (on the order of 4000 ms) [<strong>10.1002/mrm.1253</strong>].</p>
<ol start="2" type="1">
<li><strong><em>Improve statistical power:</em></strong></li>
</ol>
<p>More time points reduce signal noise and improve the ability to detect subtle changes (shape and timing) in the BOLD signal, improving sensitivity to brain activity. It also helps avoid aliasing with non-neuronal signals of higher-frequency.</p>
</section>
<section id="why-would-someone-want-to-avoid-low-trs" class="level3">
<h3 class="anchored" data-anchor-id="why-would-someone-want-to-avoid-low-trs"><strong>Why would someone want to avoid low TRs?</strong>:</h3>
<p>SNR is exponentially lower due to the reduced T1 recovery which can occur within the TR [<strong>10.1002/9781118633953</strong>].</p>
<p>At TRs below 1 second, T1 effects become more evident, with reduced contrast between the white and grey matter. This may impact registration algorithms intended to correct head-motion or to register functional data with anatomical images [<strong>10.1016/j.neuroimage.2013.05.039</strong>].</p>
</section>
<section id="general-concensus" class="level3">
<h3 class="anchored" data-anchor-id="general-concensus"><strong>General concensus:</strong></h3>
<p>A TR of ~1000±200 ms is likely to be the optimal range for many studies [<strong>10.1016/j.neuroimage.2018.05.011; 10.1002/mrm.27498</strong>]</p>
</section>
<section id="references" class="level3">
<h3 class="anchored" data-anchor-id="references"><strong>References:</strong></h3>
<ul>
<li><p>10.1016/j.pneurobio.2021.102174: Polimeni JR, Lewis LD. <strong>Imaging faster neural dynamics with fast fMRI: A need for updated models of the hemodynamic response.</strong> _Progress in Neurobiology_. 2021;207:102174</p></li>
<li><p>10.1016/j.neuroimage.2013.05.039: Smith SM, Beckmann CF, Andersson J, et al.&nbsp;<strong>Resting-state fMRI in the Human Connectome Project.</strong> <em>NeuroImage</em>. 2013;80:144-168.</p></li>
<li><p>10.1002/9781118633953: Brown RW, Cheng YCN, Haacke EM, Thompson MR, Venkatesan R. <strong>Magnetic Resonance Imaging: Physical Principles and Sequence Design</strong>. John Wiley &amp; Sons; 2014.</p></li>
<li><p>10.1016/j.neuroimage.2018.05.011: Demetriou L, Kowalczyk OS, Tyson G, Bello T, Newbould RD, Wall MB. <strong>A comprehensive evaluation of increasing temporal resolution with multiband-accelerated protocols and effects on statistical outcome measures in fMRI.</strong> _NeuroImage_. 2018;176:404-416.</p></li>
<li><p>10.1002/mrm.27498: McDowell AR, Carmichael DW. <strong>Optimal repetition time reduction for single subject event-related functional magnetic resonance imaging</strong>. _Magnetic Resonance in Medicine_. 2019;81(3):1890-1897.</p></li>
<li><p>10.1002/mrm.1253: Constable TR, Spencer DD. <strong>Repetition time in echo planar functional MRI.</strong> 2001</p></li>
</ul>
</section>
</section>
<section id="what-kind-of-acceleration-should-i-use" class="level2">
<h2 class="anchored" data-anchor-id="what-kind-of-acceleration-should-i-use">What kind of acceleration should I use?</h2>
<p><a href="https://medium.com/@m.b.wall/stop-using-crazy-multiband-sequences-for-fmri-youre-doing-it-wrong-2289b1a5a7b1">Stop Using Crazy Multiband Sequences</a></p>
<blockquote class="blockquote">
<p>Don’t get me wrong, I <em>love</em> multiband, it’s amazing, but I use it very carefully. <strong>My ‘standard’ sequence these days is MB = 2 and GRAPPA = 2. This gives a combined 4x (MB*GRAPPA) acceleration, and gives you 40-ish slices of 3x3x3mm voxels</strong> — plenty for whole-brain coverage — and a TR of about 1.25s. I’ve pushed it to MB3 on occasion when I wanted to do specific things like use thinner slices to mitigate susceptibility problems in orbito-frontal cortex, but I wouldn’t push it higher than that. (I see no problem in combining multiband with slice-based acceleration like GRAPPA/SENSE, though I know some people are dead-set against it. GRAPPA/SENSE are old, tried-and-tested technology, and they work great. Why not use them and keep the multiband acceleration factor lower?).</p>
</blockquote>
</section>
</section>
<section id="preprocessing" class="level1">
<h1>Preprocessing</h1>
<p>A lot of the preprocessing can be automated using fmriprep: see <a href="http://weberlab.wikidot.com/fmri-prep">fmri-prep</a></p>
<p>A good paper that goes over some of the common steps is this alternative preprocessing software (FuNP): <a href="https://www.frontiersin.org/articles/10.3389/fninf.2019.00005/full">https://www.frontiersin.org/articles/10.3389/fninf.2019.00005/full</a></p>
<p>After running fmriprep, though, there will be some additional steps you might want to do:</p>
<section id="dummy-scans" class="level2">
<h2 class="anchored" data-anchor-id="dummy-scans">Dummy scans:</h2>
<p>Removal of the first 5 to 10 volumes to allow for steady-state magnetisation:</p>
<pre><code>fslroi &lt;input&gt; &lt;output&gt; 5 -1</code></pre>
<p>Note: indexing (in both time and space) starts with 0 not 1! Inputting -1 for a size will set it to the full image extent for that dimension.</p>
</section>
<section id="intensity-normalization" class="level2">
<h2 class="anchored" data-anchor-id="intensity-normalization">Intensity Normalization</h2>
<pre><code>fslmaths &lt;input&gt; -ing 10000 &lt;output&gt;</code></pre>
</section>
<section id="nuisance-variable-removal" class="level2">
<h2 class="anchored" data-anchor-id="nuisance-variable-removal">Nuisance Variable Removal</h2>
<section id="nuisance-regression-of-wm-and-csf" class="level3">
<h3 class="anchored" data-anchor-id="nuisance-regression-of-wm-and-csf">Nuisance regression of WM and CSF):</h3>
<p>1-a) With the WM, we can do:</p>
<pre><code>fslmaths WM_mask_in_highres_space -ero WM_mask_in_highres_space_eroded</code></pre>
<pre><code>flirt -in WM_mask_in_highres_space_eroded \
-applyxfm \
-init rest.feat/reg/highres2example_func.mat\
-ref  example_func.nii.gz \
-out  WM_in_func_space</code></pre>
<pre><code>fslmeants -i denoised_func_data.nii.gz -m WM_mask_in_func_space --no_bin -o WM_in_func_bin_timeseries</code></pre>
<p>Note: (i) The WM_mask_highres_space can be obtained in several ways (e.g., FSL/fast, SPM12/segment)<br>
Weighted segmentation information is actually good stuff because it allows more certainty for WM voxels (vs.&nbsp;non-WM voxels). To use the information, use —no_bin in fslmeants.<br>
(ii) You want to erode the WM mask to begin with, in order to increase the certainty (e.g., reducing some boundaries with GM).</p>
<p>1-b) We can use similar procedure as above to obtain CSF_in_func_bin_timeseries</p>
<p>1-c) To regress out these two nuisance regressors:<br>
paste WM_in_func_bin_timeseries and CSF_in_func_bin_timeseries into nuisance_timeseries</p>
<pre><code>fslmaths denoised_func_data -Tmean tempMean 
fsl_glm -i denoised_func_data -d nuisance_timeseries -demean -res_out=residual</code></pre>
<p>Note: use —demean to mean-center the nuisance timeseries so that the residual makes sense. Don’t use —des_norm or —dat_norm because we are looking at the residual (but not the GLM betas) here. You also want to add the mean back so that it is a firm data set (see step (3) below).</p>
</section>
<section id="using-outputs-from-fmriprep" class="level3">
<h3 class="anchored" data-anchor-id="using-outputs-from-fmriprep">Using outputs from fmriprep:</h3>
<p>From <a href="https://www.biorxiv.org/content/10.1101/2023.06.23.546329v1.full.pdf">https://www.biorxiv.org/content/10.1101/2023.06.23.546329v1.full.pdf</a>:</p>
<blockquote class="blockquote">
<p>"Denoising followed the anatomical CompCor (aCompCor) method of removing cardiac and motion artifacts, by regressing out of each individual’s functional data the first 5 principal components corresponding to white matter signal, and the first 5 components corresponding to cerebrospinal fluid signal, as well as six subject-specific realignment parameters (three translations and three rotations) and their first-order temporal derivatives, and nuisance regressors identified by the artifact detection software <em>art</em>: <a href="https://www.nitrc.org/projects/artifact_detect/">https://www.nitrc.org/projects/artifact_detect/</a> "</p>
</blockquote>
</section>
</section>
<section id="temporal-filtering" class="level2">
<h2 class="anchored" data-anchor-id="temporal-filtering">Temporal Filtering</h2>
<p>For highpass only (recommended) [note: "highpass" removes low-frequency signals. "lowpass" does the opposite]</p>
<p>For a TR = 2.0&nbsp;s and I if you want to highpass filter at 100 seconds, this means 50 TRs (volumes), and thus highpass sigma is 25.0 TR (volumes).</p>
<pre><code>fslmaths &lt;input&gt; -Tmean tempMean
fslmaths &lt;input&gt; -bptf &lt;sigma&gt; -1 -add tempMean &lt;output&gt;
imrm tempMean</code></pre>
</section>
<section id="spatial-smoothing" class="level2">
<h2 class="anchored" data-anchor-id="spatial-smoothing">Spatial Smoothing</h2>
<p>To smooth or not to smooth? And by how much?<br>
<a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7462426">https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7462426</a></p>
<pre><code>3dmerge -1blur_fwhm &lt;kernel size in mm&gt; -doall -prefix &lt;output&gt; &lt;input&gt;</code></pre>
</section>
</section>
<section id="melodic-multivariate-exploratory-linear-optimized-decomposition-into-independent-components" class="level1">
<h1>MELODIC (Multivariate Exploratory Linear Optimized Decomposition into Independent Components)</h1>
<p>Multivariate Exploratory Linear Optimized Decomposition into Independent Components (MELODIC) uses ICA to decompose a full 4D timeseries dataset (either a single subject or multiple subjects that have been concatenated together) into 'components'. These components could be motion artifacts, cardiac/breathing artifacts, MRI noise artifacts, or resting-state brain networks, for instance.</p>
<p>I only have experience running Melodic through the GUI. To run, just type 'Melodic' in terminal</p>
<p><a href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/MELODIC">Here is the FSL main page</a></p>
<p><a href="https://fsl.fmrib.ox.ac.uk/fslcourse/lectures/practicals/ica/index.html">Here is the FSL Practical guide</a> (very useful)</p>
<p>From the link above, please note the section: Classifying and removing noise components from single-subject ICA<br>
This is very important to learn to classify and remove motion/noise/scanner/other artifacts (see below as well)</p>
<p>Here is an example of my own:</p>
<p><img src="img/icaclassification.png" class="img-fluid"></p>
<p><a href="https://users.fmrib.ox.ac.uk/~paulmc/fsleyes/userdoc/latest/ic_classification.html">I found this link</a> VERY useful for actually figuring out how to do that (not necessarily how to identify though); and <a href="https://fsl.fmrib.ox.ac.uk/fslcourse/lectures/melodic.pdf">this link</a> is for a lecture pdf</p>
<p>In order to manually classify, here is an example of how to start FSLeyes</p>
<pre><code>fsleyes --scene melodic -ad Rest_EPI.ica/filtered_func_data.ica &amp;</code></pre>
<p>After signals have been classified, you then save the classifications to a .txt file, the end of which will look like this:</p>
<pre><code>22, Cardiac, True                                                                                     
23, Signal, False                                                                                     
24, Unclassified noise, True                                                                          
25, Movement, True                                                                                    
26, Movement, True                                                                                    
27, Movement, True                                                                                    
28, Signal, False                                                                                     
29, Unclassified noise, True                                                                          
30, Unclassified noise, True                                                                          
[1, 2, 3, 4, 5, 6, 7, 8, 10, 11, 15, 18, 20, 21, 22, 24, 25, 26, 27, 29, 30]</code></pre>
<p>Those numbers at the end are what you want: they are all the non-brain signals that you want to get rid of.</p>
<p>Here's an example of how to get rid of those signals:</p>
<pre><code>fsl_regfilt -i filtered_func_data.nii.gz -d filtered_func_data.ica/melodic_mix -o filtered_func_data_clean.nii.gz -f "1, 2, 3, 4, 5, 6, 7, 8, 10, 11, 15, 18, 20, 21, 22, 24, 25, 26, 27, 29, 30"</code></pre>
<p>-i is the input from the melodic output; -d is for the melodic_mix; and -o is just your output filename, which is your new cleaned up 4D file.</p>
<section id="melodic-through-command-line" class="level2">
<h2 class="anchored" data-anchor-id="melodic-through-command-line">Melodic through command line</h2>
<p>You can automate Melodic and not have to use the GUI every time.<br>
This requires having a design.fsf file, which Melodic GUI creates every time you run an analysis.<br>
Using a sample one, you can edit it with a simple editer, like 'nano'</p>
<pre><code>nano design.fsf</code></pre>
<p>You will have to change the file name and directory, the output directory, possibly the number of volumes, etc.</p>
<p>When you are ready, all you have to do is run:</p>
<pre><code>feat design.fsf</code></pre>
<p>To suppress the automatic opening of the browser window, make sure to uncheck the "Progress Watcher" in the Misc Tab.<br>
Or, change the featwatcher_yn parameter in the design.fsf from a 1 to a 0:</p>
<pre><code># Run Featwatcher
set fmri(featwatcher_yn) 0</code></pre>
<section id="easy-fsl_regfilt" class="level3">
<h3 class="anchored" data-anchor-id="easy-fsl_regfilt">easy fsl_regfilt</h3>
<pre><code>components=$(awk 'NR&gt;1{print $1}' RS=[ FS=] labels)
fsl_regfilt -i filtered_func_data.nii.gz -d filtered_func_data.ica/melodic_mix -o filtered_func_data_clean.nii.gz -f "${components}"</code></pre>
</section>
</section>
<section id="signal-classification" class="level2">
<h2 class="anchored" data-anchor-id="signal-classification">Signal Classification</h2>
<p>Former MASc student Olivia Campbell going through ICA signal classification: <a href="https://drive.google.com/file/d/1hxBUNFbtUHBEKMYWt1bCzclwZSHvSHEH/preview">https://drive.google.com/file/d/1hxBUNFbtUHBEKMYWt1bCzclwZSHvSHEH/preview</a></p>
<p>Signal classification flowchat:</p>
<p><img src="img/iceflowchart.png" class="img-fluid"></p>
<p>And from FSL:</p>
<p><img src="img/fslicaclass.png" class="img-fluid"></p>
<p>Tips for manual classification: (taken from [<a href="https://www.sciencedirect.com/science/article/pii/S1053811916307583">https://www.sciencedirect.com/science/article/pii/S1053811916307583</a> ])</p>
<ul>
<li>About 70% of components should be noise, the other 30% signal
<ul>
<li>So for the 70 component ICA,there should be about 20 signals</li>
</ul></li>
<li>The first components that Melodic lists are usually noise</li>
<li>Make sure that the signal is located in grey matter throughout ALL planes</li>
<li>The overall aim is to preserve as much signal as possible
<ul>
<li>Components are "innocent until proven guilty" (components are signals until proven noise)</li>
</ul></li>
<li>Use the spatial map as the main decision maker, then look at time series and power spectra</li>
<li>General criteria for signal classification:</li>
</ul>
<ol type="1">
<li>Spatial maps need to be in grey matter, away from main veins, WM, CSF</li>
<li>Time series should be without sudden or abrupt changes</li>
<li>Power spectra should largely show power at low frequency</li>
</ol>
<p>For automatic classification, you can use <a href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FIX">FIX</a>, but that requires you to manually train the data…<br>
or <a href="https://fcp-indi.github.io/docs/user/aroma_ica">ICA-AROMA</a> which I think is supposed to work well on getting rid of motion… (<a href="https://github.com/maartenmennes/ICA-AROMA/blob/master/Manual.pdf">here's the manual</a>)</p>
<p>Other options are:<br>
<a href="https://fmriprep.org/en/stable/index.html">https://fmriprep.org/en/stable/index.html</a><br>
<a href="https://github.com/BMHLab/DiCER">https://github.com/BMHLab/DiCER</a><br>
<a href="https://www.nitrc.org/projects/artifact_detect">https://www.nitrc.org/projects/artifact_detect</a></p>
</section>
</section>
<section id="ica-fix" class="level1">
<h1>ICA FIX</h1>
<p><a href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FIX/UserGuide">https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FIX/UserGuide</a></p>
<section id="fMRI-Install" class="level2">
<h2 class="anchored" data-anchor-id="fMRI-Install">Install</h2>
<p>FIX requires FSL, Matlab (should be installed on all our computers), and R with the following packages installed: 'kernlab' version 0.9.24; 'ROCR' version 1.0.7; 'class' version 7.3.14; 'party' version 1.0.25; 'e1071' version 1.6.7; 'randomForest' version 4.6.12</p>
<p>To install these R packages; enter R (type: <code>R</code>) and enter:</p>
<pre><code>install.packages(c("kernlab","ROCR","e1071","randomForest","devtools"))</code></pre>
<p>Then:</p>
<pre><code>require(devtools)
install_version("mvtnorm", version="1.0-8")
install_version("multcomp", version="1.4-8")
install_version("coin", version="1.2-2")
install_version("party", version="1.0-25")</code></pre>
<p>When asked if you want to update to a newer version, just press enter ('empty line to skip updates')</p>
<p>To quit R, type: <code>quit()</code></p>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup:</h2>
<ul>
<li>Unpack <a href="http://www.fmrib.ox.ac.uk/~steve/ftp/fix.tar.gz">FIX (1.06.15)</a> with <code>tar xvfz fix.tar.gz</code> (or <code>tar xvf fix.tar</code> if your browser has already uncompressed the file).</li>
</ul>
<p>We installed in: <code>/usr/local/fix</code></p>
<ul>
<li>Download and install matlab compiled runtime (MCR) for your operating system (mac, <a href="https://ssd.mathworks.com/supportfiles/downloads/R2017b/deployment_files/R2017b/installers/glnxa64/MCR_R2017b_glnxa64_installer.zip">linux</a>)</li>
</ul>
<p><a href="https://www.mathworks.com/help/compiler_sdk/dotnet/install-the-matlab-runtime.html">How to Install MCR</a></p>
<p>NOTE: We set our Matlab to be the installed version (<code>which matlab</code>). See the <code>settings.sh</code> file in: <code>/usr/local/fix</code>]</p>
<ul>
<li>See the README file for further setup instructions (in <code>/usr/local/fix</code></li>
</ul>
</section>
<section id="path" class="level2">
<h2 class="anchored" data-anchor-id="path">Path</h2>
<p>Change your path to include: <code>/usr/local/fix</code></p>
</section>
<section id="files-needed" class="level2">
<h2 class="anchored" data-anchor-id="files-needed">Files needed</h2>
<pre><code>  filtered_func_data.nii.gz          preprocessed 4D data
  filtered_func_data.ica             melodic (command-line program) full output directory
  mc/prefiltered_func_data_mcf.par   motion parameters created by mcflirt (in mc subdirectory)
  mask.nii.gz                        valid mask relating to the 4D data
  mean_func.nii.gz                   temporal mean of 4D data
  reg/example_func.nii.gz            example image from 4D data
  reg/highres.nii.gz                 brain-extracted structural
  reg/highres2example_func.mat       FLIRT transform from structural to functional space
  design.fsf                         FEAT/MELODIC setup file; if present, this controls the
                                       default temporal filtering of motion parameters</code></pre>
<p>The design.fsf is optional.</p>
<p>Here is a sample script that will create the FIX input directory and run FIX. You will need to change the files to suit your needs.</p>
<pre><code>highDir=/home/johann.drayne/testing/fix/denoise/
derivDir=/mnt/WeberLab/Projects/NeonateSucrose/SickKids/derivatives/

#### output Directory ####
outputDir=${highDir}output

#### training file that you give to FIX ####
classifier=/mnt/WeberLab/Data/dHCP/train35.RData

#### skull stripped anatomical image ####
anat=${highDir}MS040008-session1_restore_brain

#### functional image registered to anat space ####
fmri2anat=${highDir}_bold2template

#### motion corrected input functional image ####
fmri=${derivDir}motioncorrectedfmri/_MS040008motioncorrected.nii.gz

#### linear transform of functional to anat space ####
f2amat=${derivDir}tempmotioncorrectedfmriv01mat/MS040008/_rigid_avgfmri_to_t10GenericAffine.mat

mkdir ${outputDir}
mkdir ${outputDir}/split/
mkdir ${outputDir}/reg/
mkdir ${outputDir}/mc

### splitting 4D file to add example image into output/reg #####
fslsplit ${fmri} ${outputDir}/split/
cp ${outputDir}/split/0000.nii.gz ${outputDir}/reg/example_func.nii.gz
echo "----- Func single volume copied to output -----"

### creating binary mask using fslmaths #####
antsApplyTransforms -d 3 -o ${outputDir}/anat2func.nii.gz -t [${f2amat}, 1] -r ${outputDir}/reg/example_func.nii.gz -i ${anat}.nii
fslmaths ${outputDir}/anat2func -thrp 5 -bin ${outputDir}/mask
echo "----- Binary Mask Complete -----"

#### running melodic on fmri #####
melodic -i ${derivDir}motioncorrectedfmri/_MS040008motioncorrected -o ${outputDir}/filtered_func_data.ica  -m ${outputDir}/mask --nobet -v
echo "----- MELODIC Complete -----"

#### adding mean to output #####
cp ${outputDir}/filtered_func_data.ica/mean.nii.gz ${outputDir}/mean_func.nii.gz
echo "----- mean added to output -----"

#### adding skull stripped anat to output/reg/ #####
cp ${anat}.nii ${outputDir}/reg/highres.nii.gz
echo "----- Skull Stripped anat copied to output -----"

#### adding func to output #####
cp ${fmri} ${outputDir}/filtered_func_data.nii.gz
echo "----- Func copied to output -----"

#### creating .par file in output/mc/ with mcflirt #####
mcflirt -in ${fmri} -plots -o ${outputDir}/mc/prefiltered_func_data_mcf
echo "----- mcflirt motion parameters in output -----"

#### creating .mat transformation from ANTs to FSL format anat -&gt; func space#####
c3d_affine_tool -itk ${f2amat} -ref ${anat}.nii -src ${outputDir}/reg/example_func.nii.gz -ras2fsl -o ${outputDir}/reg/highres2example_func.mat -inv
echo "----- .mat file added to output -----"

### running FIX #####
/usr/local/fix/fix -f ${outputDir}/
echo "----- Extracted Feautres -----"

/usr/local/fix/fix -c ${outputDir}/ ${classifier} 5
echo "----- Classified ICA Components ------"

/usr/local/fix/fix -a ${outputDir}/fix4melview_train35_thr5.txt
echo "----- FIX Complete -----"</code></pre>
</section>
</section>
<section id="global-rsns" class="level1">
<h1>Global RSNs</h1>
<p>Common Resting State Network atlases exist online. Here is one resource:<br>
<a href="https://www.fmrib.ox.ac.uk/datasets/brainmap+rsns/">https://www.fmrib.ox.ac.uk/datasets/brainmap+rsns/</a></p>
<section id="identifying-rsns" class="level2">
<h2 class="anchored" data-anchor-id="identifying-rsns">Identifying RSNs</h2>
<p><img src="img/globalRSNs.png" class="img-fluid"></p>
<p>Maps 120, 220 and 320 (“visual”) correspond to medial, occipital pole, and lateral visual areas. The explicitly visual behavioral domains correspond most strongly to these maps, and paradigms cognition–language–orthography and cognition–space correspond to the occipital pole and lateral visual maps, respectively. We presume that the “orthography” correspondence reflects the visual nature of stimuli used in these studies (e.g., written-word forms).</p>
<p>Map 420 (“default mode network”) includes medial parietal (precuneus and posterior cingulate), bilateral inferior–lateral–parietal and ventromedial frontal cortex. This is often referred to as the default mode network (9), and is possibly the most widely studied RSN in the resting-state FMRI literature. This is also the network that is most commonly seen as deactivating in task-based FMRI experiments; hence, one would not expect this map to correspond strongly to any particular behavioral domain, because more contrasts associated with any given paradigm will, on average, be looking for positive activations rather than deactivations (or negative contrasts). However, there will be some studies that contain a “deactivation” contrast, and hence, we are not surprised that this map is found in our analysis of BrainMap. Indeed, inspection of the full set of experiments reveals that this map does indeed correspond in general to negative contrasts, in particular in cognitive paradigms.</p>
<p>Map 520 (“cerebellum”) covers the cerebellum. Because of limited field of view of the MRI acquisitions in some of the resting FMRI subjects, more inferior parts of the cerebellum are not included in the multisubject RSN analysis. This corresponds most strongly to action–execution and perception–somesthesis–pain domains.</p>
<p>Map 620 (“sensorimotor”) includes supplementary motor area, sensorimotor cortex, and secondary somatosensory cortex. This corresponds closely to the activations seen in bimanual motor tasks and was the first resting state network to be identified in FMRI data (1). This corresponds most strongly to the action–execution and perception–somesthesis paradigms.</p>
<p>Map 720 (“auditory”) includes the superior temporal gyrus, Heschl's gyrus, and posterior insular. It includes primary and association auditory cortices. This corresponds most strongly to action–execution–speech, cognition–language–speech, and perception–audition paradigms.</p>
<p>Map 820 (“executive control”) covers several medial–frontal areas, including anterior cingulate and paracingulate. This corresponds strongly to several cognition paradigms, as well as action–inhibition, emotion, and perception–somesthesis–pain.</p>
<p>Maps 920 and 1020 (“frontoparietal”) cover several frontoparietal areas. These are the only maps to be strongly lateralized, and are largely left–right mirrors of each other. They correspond to several cognition/language paradigms. In addition, map 920 corresponds strongly to perception–somesthesis–pain; this is consistent with the insular areas seen (see SI for more detailed figures showing all maps). Map 1020 corresponds strongly to cognition–language paradigms, which is consistent with the Broca's and Wernicke's areas seen in the map (see SI for slices more clearly showing these areas). Given the known lateralization of language function, it is not surprising that these (mirrored) networks have such different behavioral domain associations.</p>
<p>from <a href="https://www.pnas.org/content/106/31/13040">https://www.pnas.org/content/106/31/13040</a></p>
</section>
</section>
<section id="functional-connectivity-analysis" class="level1">
<h1>Functional Connectivity Analysis</h1>
<p>Run MELODIC on your group data in Concat-ICA mode ("Multi-session temporal concatenation"). Find the file containing the ICA spatial maps output by the group-ICA; this will be called something like melodic_IC.nii.gz and will be inside a something.ica MELODIC output directory.</p>
<p>Use <a href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/GLM">FSL's Glm</a> (or any other method) to create your multi-subject design matrix and contrast files (design.mat / design.con).</p>
<p>Run <a href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/DualRegression/UserGuide">FSL's dual_regression</a>. Just type the script name to get the usage - should be mostly self-explanatory:</p>
<ul>
<li>The 4D group spatial IC maps file will be something like somewhere.ica/melodic_IC</li>
<li>The des_norm option determines whether to variance-normalise the timecourses created by stage 1 of the dual regression; it is these that are used as the regressors in stage 2. If you don't normalise them, then you will only test for RSN "shape" in your cross-subject testing. If you do normalise them, you are testing for RSN "shape" and "amplitude".</li>
<li>One easy way to get the list of inputs (all subjects' standard-space 4D timeseries files) at the end of the command is to use the following (instead of listing the files explicitly, by hand), to get the list of files that was fed into your group-ICA: `cat somewhere.gica/.filelist`</li>
</ul>
<section id="statistics" class="level2">
<h2 class="anchored" data-anchor-id="statistics">Statistics</h2>
<p>Finally you'll want to use <a href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/Randomise/UserGuide">FSL's randomise</a></p>
<section id="example" class="level3">
<h3 class="anchored" data-anchor-id="example">Example:</h3>
<p>From my 2014 paper: <a href="https://www.sciencedirect.com/science/article/pii/S0278584614000773">https://www.sciencedirect.com/science/article/pii/S0278584614000773</a></p>
<blockquote class="blockquote">
<p>Group differences were obtained from the Dual Regression program, where the different sets of spatial maps were collected across subjects into single 4D files (one per RSN) and analyzed across groups (OCD vs.&nbsp;Control) using non-parametric statistical analysis involving permutation testing (Beckmann et al., 2009). The number of permutations was set at 10,000 to maximize alpha level calculations (Webster, 2012). As this study is the first ICA analysis of OCD with no specific RSN being tested, it was treated as exploratory in nature (i.e.&nbsp;as a pilot study); thus, correction for multiple-comparisons (Bonferroni) was not performed.</p>
</blockquote>
</section>
</section>
</section>
<section id="fMRI-NetworkModellingAnalysis" class="level1">
<h1>Network Modelling Analysis</h1>
<p>FSL has a great set of tutorial videos using their program FSL-NETS. The videos start with preprocessing:</p>
<p><a href="https://www.youtube.com/watch?v=Bm3kUPP-tIc">https://www.youtube.com/watch?v=Bm3kUPP-tIc</a></p>
<section id="nodes" class="level2">
<h2 class="anchored" data-anchor-id="nodes">Nodes:</h2>
<p>Nodes are how you decide to divide/segment the brain</p>
<section id="contiguous-vs-non-contiguous" class="level3">
<h3 class="anchored" data-anchor-id="contiguous-vs-non-contiguous">Contiguous vs Non-contiguous:</h3>
<p>Contiguous nodes are single ROIs</p>
<p>Non-contiguous nodes might be two or more ROIs together: for example, similar regions across hemispheres (left and right)</p>
</section>
<section id="binary-or-weighted" class="level3">
<h3 class="anchored" data-anchor-id="binary-or-weighted">Binary or Weighted:</h3>
<p>Binary nodes are thresholded and then given 0 or 1. This is intuitive for graph representation and interpretation</p>
<p>Weighted is when you do not threshold and just use the raw correlation value. This fits with complex brain organization and allows measurement error and physiological limits (HRF)</p>
</section>
<section id="node-definition" class="level3">
<h3 class="anchored" data-anchor-id="node-definition">Node Definition:</h3>
<ul>
<li>Anatomical (e.g.&nbsp;Harvard-Oxford) - not great for resting state fMRI</li>
<li>Functional atlases (e.g.&nbsp;Yeo 2011 / Glasser 2016) - not data-driven</li>
<li>Data-driven parcellation (e.g.&nbsp;ICA, clustering, gradients) - data-driven</li>
</ul>
</section>
</section>
<section id="timeseries" class="level2">
<h2 class="anchored" data-anchor-id="timeseries">Timeseries:</h2>
<p>From each node, you will average the time-series of all the voxels within the node to give that node’s time-series</p>
<p>For getting the time-series from ICA, use <a href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/DualRegression">FSL’s dual-regression</a></p>
</section>
<section id="edges" class="level2">
<h2 class="anchored" data-anchor-id="edges">Edges:</h2>
<p>This is the temporal correlation of the timeseries between nodes</p>
<p>You can represent edges in three different ways:</p>
<ul>
<li>presence or absence of edges</li>
<li>strength of edges</li>
<li>and directionality of edges (hard to estimate with BOLD data)</li>
</ul>
<p>Also, there are direct and indirect connections: where node 2 is indirectly correlated with node 3 through node 1</p>
<p><img src="img/nodes.png" class="img-fluid"></p>
<p>To avoid this, you can regress out node 1 from both 2 and 3. If 2 and 3 are still correlated, a direct connection exists. When you perform this correction, it is called partial correlation.</p>
</section>
<section id="network-matrix" class="level2">
<h2 class="anchored" data-anchor-id="network-matrix">Network Matrix:</h2>
<p>Colored matrix which tells you node-node strength</p>
<section id="hierarchical-clustering" class="level3">
<h3 class="anchored" data-anchor-id="hierarchical-clustering">Hierarchical clustering:</h3>
<p>This groups common nodes together</p>
<p>Note: this is not a statistical test</p>
</section>
</section>
<section id="group-analysis" class="level2">
<h2 class="anchored" data-anchor-id="group-analysis">Group Analysis</h2>
<p>Network Matrix → take just the upper diagonal → convert this to a single dimension of just edge values → then do this for all subjects to create a 2D matrix where each row is a subject, and each column an edge.</p>
<p>To perform group level comparisons, you would then run a GLM</p>
</section>
</section>
<section id="notes-on-distortion-correction" class="level1">
<h1>Notes on Distortion Correction</h1>
<p><a href="https://docs.google.com/document/d/17kC6q0hr3q6vlMEFDnIqEvpmmBxvLBc5F_PUfsyxLvU/edit">https://docs.google.com/document/d/17kC6q0hr3q6vlMEFDnIqEvpmmBxvLBc5F_PUfsyxLvU/edit</a></p>
</section>
<section id="multi-echo-fmri" class="level1">
<h1>Multi-echo fMRI</h1>
<p><a href="https://hackmd.io/@weberam2/HypP3Pr8j">https://hackmd.io/<span class="citation" data-cites="weberam2/HypP3Pr8j">@weberam2/HypP3Pr8j</span></a></p>
</section>
<section id="post-processing-pipelines" class="level1">
<h1>Post-processing Pipeline(s):</h1>
<section id="xcp-d" class="level2">
<h2 class="anchored" data-anchor-id="xcp-d">XCP-D</h2>
<p><a href="https://xcp-d.readthedocs.io/en/latest/index.html">https://xcp-d.readthedocs.io/en/latest/index.html</a></p>
<blockquote class="blockquote">
<p>XCP-D paves the final section of the reproducible and scalable route from the MRI scanner to functional connectivity data in the hands of neuroscientists. We developed XCP-D to extend the BIDS and NiPrep apparatus to the point where data is most commonly consumed and analyzed by neuroscientists studying functional connectivity. Thus, with the development of XCP-D, data can be automatically preprocessed and analyzed in BIDS format, using NiPrep-style containerized code, all the way from the scanner to functional connectivity matrices.</p>
</blockquote>
</section>
<section id="conn-toolbox" class="level2">
<h2 class="anchored" data-anchor-id="conn-toolbox">CONN Toolbox</h2>
<p><a href="http://www.nitrc.org/projects/conn">http://www.nitrc.org/projects/conn</a></p>
<p><a href="https://web.conn-toolbox.org/fmri-methods/denoising-pipeline">https://web.conn-toolbox.org/fmri-methods/denoising-pipeline</a></p>
<section id="tutorial" class="level3">
<h3 class="anchored" data-anchor-id="tutorial">Tutorial:</h3>
<p><a href="https://andysbrainbook.readthedocs.io/en/latest/FunctionalConnectivity/CONN_Overview.html">https://andysbrainbook.readthedocs.io/en/latest/FunctionalConnectivity/CONN_Overview.html</a></p>


</section>
</section>
</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/BCCH-MRI-Research-Facility\.github\.io\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/BCCH-MRI-Research-Facility/BCCH-MRI-Research-Facility.github.io/edit/main/mrimethods/fMRI.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/BCCH-MRI-Research-Facility/BCCH-MRI-Research-Facility.github.io/blob/main/mrimethods/fMRI.qmd" class="toc-action"><i class="bi empty"></i>View source</a></li><li><a href="https://github.com/BCCH-MRI-Research-Facility/BCCH-MRI-Research-Facility.github.io/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>